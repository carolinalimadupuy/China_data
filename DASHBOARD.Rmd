---
title: "Dashboard: Transacciones chinas 2024"
author: "Carolina Lima Dupuy"
output:
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    self_contained: true
runtime: static
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(rio)
library(janitor)
library(plotly)
library(DT)
library(broom)
library(psych)
library(cluster)
library(factoextra)
library(sandwich)
library(lmtest)
library(car)
library(kableExtra)
library(gridExtra)
library(corrplot)
library(ggrepel)
options(scipen = 999)

```

Row {data-height=300}
-------------------------------------

### Resumen general de IED desde China

```{r}
# URL de tu base limpia desde GitHub:
url <- "https://raw.githubusercontent.com/carolinalimadupuy/China_data/main/China_data_limpia.xlsx"

# Importa y limpia
data <- import(url) %>% clean_names()

# Asegurar tipos
data <- data %>% mutate(
  country = as.factor(country),
  region = as.factor(region),
  bri = as.factor(bri),
  usadf = as.numeric(usadf),
  idi_2024 = as.numeric(idi_2024)
)

# Tabla resumen
summary_table <- data %>%
  arrange(desc(ied_china)) %>%
  select(country, region, ied_china, bri, pbi, idi_2024, usadf)

top10 <- head(summary_table, 10)

# Histograma
p_hist <- ggplot(data, aes(x = ied_china)) +
  geom_histogram(bins = 30, fill = "steelblue", color = "white") +
  labs(title = "Distribución de IED desde China", x = "IED (mill. USD)")

p_hist_plotly <- plotly::ggplotly(p_hist)
p_hist_plotly
```

La distribución del IED proveniente de China presenta una marcada asimetría positiva, caracterizada por una alta concentración de países en niveles de inversión reducidos y una cola extendida hacia valores elevados. Este patrón indica que, aunque la mayoría de economías recibe flujos modestos, existe un grupo reducido de países que concentra montos sustancialmente mayores, lo cual es consistente con estrategias de inversión selectiva y focalizada por parte de China.


Column {data-width=350}
-------------------------------------

### Tabla: Top 10 países por IED

```{r}
DT::datatable(top10, options = list(pageLength = 10))
```

La tabla de los diez países que reciben mayor inversión extranjera directa de China evidencia una fuerte concentración geoeconómica, donde solo un conjunto reducido de países captura una proporción sustantiva de los flujos totales. Este patrón confirma que la estrategia de inversión china no se distribuye de manera uniforme, sino que prioriza economías específicas que podrían ser por criterios estratégicos, estructurales o regionales. 


Row {data-height=400}
-------------------------------------

### Comparaciones clave y asociaciones

```{r}
# Scatterplots: IED vs PBI
p1 <- ggplot(data, aes(x = pbi, y = ied_china, color = bri)) +
geom_point(size = 2.5) +
geom_smooth(method = "lm", se = FALSE, color = "black") +
scale_x_continuous(labels = scales::comma) +
labs(title = "IED vs PBI (por país)", x = "PBI (mill. USD)", y = "IED China (mill. USD)")

p1_plotly <- plotly::ggplotly(p1)
p1_plotly

```

```{r}
# Scatterplots: IED vs IDI_2024
p2 <- ggplot(data, aes(x = idi_2024, y = ied_china, color = bri)) +
geom_point(size = 2.5) +
geom_smooth(method = "lm", se = FALSE, color = "black") +
labs(title = "IED vs IDI 2024", x = "Índice de Desarrollo Digital (IDI)", y = "IED China (mill. USD)")

p2_plotly <- plotly::ggplotly(p2)
p2_plotly

```

```{r}
# Scatterplots: IED vs USADF
p3 <- ggplot(data, aes(x = usadf, y = ied_china, color = bri)) +
geom_point(size = 2.5) +
geom_smooth(method = "lm", se = FALSE, color = "black") +
labs(title = "IED vs USADF", x = "Ayuda EEUU (USADF)", y = "IED China (mill. USD)")

p3_plotly <- plotly::ggplotly(p3)
p3_plotly

```

```{r}
# Boxplot IED por BRI (alianza)
bp_bri <- ggplot(data, aes(x = bri, y = ied_china)) +
geom_boxplot(fill = "steelblue") +
labs(x = "BRI (0/1)", y = "IED China (mill. USD)", title = "IED según alianza BRI")

bp_bri_plotly <- plotly::ggplotly(bp_bri)
bp_bri_plotly

```

```{r}
# Boxplot IED por REGION
bp_region <- ggplot(data, aes(x = region, y = ied_china)) +
  geom_boxplot(fill = "coral") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Región", y = "IED China (mill. USD)", title = "IED según Región")

bp_region_plotly <-plotly::ggplotly(bp_region)
bp_region_plotly
```

1. IED vs PBI

La relación entre la IED china y el PBI muestra una asociación positiva, aunque débil, consistente con la regresión previa: los países con economías más grandes tienden a recibir mayores flujos de inversión, pero la variabilidad es amplia y el patrón está dominado por unos pocos casos de IED excepcionalmente alta. Esto revela que el tamaño económico es un factor relevante, pero no suficiente por sí solo para explicar la distribución de la IED china.

2. IED vs IDI 

El nivel de desarrollo digital no exhibe una relación clara con la IED china. La nube de puntos es dispersa y la línea de tendencia permanece prácticamente horizontal, lo que indica que la estrategia inversora de China no sigue un patrón asociado al grado de digitalización de los países.

3. IED vs USADF (ayuda estadounidense)

La relación entre ayuda estadounidense e inversión china es prácticamente nula. Los valores de USADF no predicen los flujos de IED y la línea de tendencia carece de pendiente relevante. Este resultado coincide con los modelos de regresión y sugiere que la presencia de Estados Unidos en términos de cooperación no desplaza ni atrae por sí misma la inversión china.

4. IED por pertenencia a la BRI

El boxplot indica que los países miembros de la Iniciativa de la Franja y la Ruta (BRI) presentan una mediana de IED mayor que los no miembros, aunque ambos grupos muestran dispersión amplia. Ello sugiere que pertenecer a la BRI incrementa la probabilidad de recibir mayores montos de inversión, pero no de manera uniforme entre los países.

5. IED por Región

Las diferencias regionales en los flujos de IED son pronunciadas. Algunas regiones concentran casos de inversión muy elevada mientras que otras muestran niveles sistemáticamente bajos. Esta heterogeneidad confirma que la distribución territorial de la IED china responde a criterios geopolíticos diferenciados entre regiones.


Row {data-height=400}
-------------------------------------

### Matriz de correlaciones entre variables cuantitativas

```{r}
library(corrplot)

# Seleccionar variables numéricas
numeric_data <- data %>%
  select(ied_china, pbi, usadf, idi_2024)

# Matriz de correlación
corr_matrix <- cor(numeric_data, use = "complete.obs")

# Heatmap de correlaciones
corrplot(corr_matrix, method = "color", type = "upper",
         addCoef.col = "black", number.cex = 0.7,
         tl.col = "black", tl.srt = 45)
```

La matriz de correlaciones revela asociaciones lineales débiles entre la IED china y las variables estructurales analizadas. El PBI muestra una correlación positiva muy baja (r ≈ 0.13), mientras que la ayuda estadounidense (r ≈ –0.09) y el IDI (r ≈ –0.07) presentan vínculos ligeramente negativos. De igual modo, las correlaciones entre las variables explicativas también son reducidas, sin evidencias de colinealidad sustantiva.


### Modelos de regresión: OLS y modelo logarítmico

```{r}
 # Modelo OLS en niveles
mod_ols <- lm(ied_china ~ bri + pbi + idi_2024 + usadf + region, data = data)
summary(mod_ols)

# Errores robustos (HC1)
coeftest(mod_ols, vcov = vcovHC(mod_ols, type = "HC1"))

# VIF (multicolinealidad)
vif(mod_ols)

# Test de heterocedasticidad
bptest(mod_ols)

# Normalidad de los errores
shapiro.test(residuals(mod_ols))

# Tabla de coeficientes limpia
tidy(mod_ols) %>%
  mutate(estimate = round(estimate, 4),
         std.error = round(std.error, 4),
         p.value = round(p.value, 4)) %>%
  kable(caption = "Coeficientes OLS (niveles)")
```

```{r}
# Modelo logarítmico (log1p para manejar ceros)
data <- data %>% mutate(log_ied = log1p(ied_china))
mod_log <- lm(log_ied ~ bri + pbi + idi_2024 + usadf + region, data = data)
summary(mod_log)
coeftest(mod_log, vcov = vcovHC(mod_log, type = "HC1"))

tidy(mod_log) %>%
  mutate(estimate = round(estimate, 4),
         std.error = round(std.error, 4),
         p.value = round(p.value, 4)) %>%
  kable(caption = "Coeficientes logarítmico (log1p)")
```

```{r}
# Comparación: valores observados vs valores predichos
p1 <- ggplot(data, aes(x = fitted(mod_ols), y = ied_china)) +
  geom_point(color = "steelblue", size = 2) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
  labs(
    title = "Comparación: Valores Observados vs Predichos",
    x = "Predicción del Modelo (IED China)",
    y = "IED China Observada"
  ) +
  theme_minimal()
p1
```

```{r}
# Distribución de los errores del modelo
p2 <- ggplot(data, aes(x = residuals(mod_ols))) +
  geom_histogram(bins = 20, fill = "coral", color = "white") +
  labs(
    title = "Distribución de Errores del Modelo",
    x = "Error (IED Observada - Predicha)",
    y = "Frecuencia"
  ) +
  theme_minimal()
p2
```

```{r}
# Influencia de los países en el modelo (Leverage)
lev <- hatvalues(mod_ols)
p3 <- ggplot(data, aes(x = lev, y = residuals(mod_ols))) +
  geom_point(color = "purple", size = 2) +
  labs(
    title = "Influencia de los Países en el Modelo",
    x = "Influencia de cada país",
    y = "Error de Predicción"
  ) +
  theme_minimal()
p3
```
```{r}
library(plotly)

# Scatterplots combinados

scatter_row <- plotly::subplot(
plotly::ggplotly(p1),
plotly::ggplotly(p2),
plotly::ggplotly(p3),
nrows = 1, margin = 0.05
)
scatter_row

```

Modelos de regresión

Para evaluar los determinantes del patrón de transacciones económicas exteriores de China (medido mediante la IED en millones de USD), se estimaron dos modelos de regresión lineal múltiple: uno en niveles y uno logarítmico. Ambos incluyen como variables explicativas la pertenencia a la Iniciativa de la Franja y la Ruta (BRI), el PBI, el nivel de desarrollo digital (IDI), la ayuda estadounidense (USADF) y la región geográfica del país.

Modelo OLS en niveles

Con errores robustos, la pertenencia al BRI muestra un efecto positivo y estadísticamente significativo (β = 412.47, p = 0.026), lo que indica que los países incorporados en esta iniciativa reciben montos mayores de IED en comparación con los no miembros. El PBI presenta un efecto positivo pero no estadísticamente significativo, mientras que el IDI y la asistencia estadounidense tampoco muestran impactos relevantes en este modelo. En cambio, varias regiones exhiben coeficientes negativos significativos, evidenciando diferencias geográficas consistentes en la distribución de la IED china. El R² ajustado es bajo (0.13) y los residuos no presentan normalidad, lo que sugiere limitaciones en el ajuste del modelo en niveles.

Modelo logarítmico 

Al transformar la variable dependiente, el modelo mejora su capacidad explicativa (R² ajustado ≈ 0.23) y estabiliza la varianza. En esta especificación, el PBI adquiere un efecto positivo y significativo (β = 1.20e−06, p = 0.046), lo que implica que economías más grandes tienden a recibir mayores flujos de inversión china. El coeficiente del BRI mantiene un efecto positivo y marginalmente significativo (β = 1.07, p = 0.075), sugiriendo que la pertenencia al BRI se asocia a un aumento considerable en la IED, aunque con menor precisión estadística. Los efectos regionales continúan siendo relevantes, confirmando la persistencia de patrones territoriales diferenciados.

Conclusión del análisis de regresión

El modelo logarítmico representa mejor el comportamiento de los flujos de IED china. Los resultados indican que:

La pertenencia al BRI incrementa de manera significativa o marginal la IED, lo que respalda su función como instrumento de alineamiento político y económico.

El tamaño económico del país (PBI) es un determinante relevante cuando se ajusta por asimetría mediante logaritmos.

El desarrollo digital y la asistencia estadounidense no muestran efectos estadísticamente significativos en esta muestra.

Persisten diferencias regionales sustantivas, lo que evidencia que factores geográficos y estratégicos continúan guiando la asignación de la inversión exterior china.


### Análisis factorial (PCA)

```{r}
# Seleccionamos solo variables numéricas
pca_data <- data %>%
  select(ied_china, pbi, usadf, idi_2024)

# Escalar las variables (muy importante en PCA)
pca_scaled <- scale(pca_data)
```

```{r}
pca_res <- prcomp(pca_scaled, center = TRUE, scale. = TRUE)
summary(pca_res)
```

```{r}
pca_res$rotation
```

El análisis factorial mediante Componentes Principales (PCA) se aplicó a las variables numéricas IED China, PBI, USADF y IDI 2024, todas previamente estandarizadas. Los dos primeros componentes explican el 55.5% de la varianza total, mientras que los tres primeros alcanzan 78.3%, lo que indica que el PCA captura adecuadamente la estructura subyacente de los datos.

El PC1 refleja una dimensión económico-estratégica, asociando mayores niveles de inversión china y tamaño económico con menor dependencia de ayuda estadounidense y desarrollo digital. El PC2 destaca la dimensión tecnológica, separando países con alto desarrollo digital de aquellos con mayor asistencia estadounidense. El PC3 evidencia un componente geopolítico, vinculado a la alineación económica hacia Estados Unidos. Finalmente, el PC4 identifica situaciones atípicas donde el tamaño económico y la IED china no coinciden, capturando casos residuales relevantes.

En conjunto, el PCA permite comprender las dimensiones económico, tecnológica y geopolítica que estructuran los flujos de inversión china en los países durante 2024.

```{r}
library(factoextra)
fviz_eig(pca_res, addlabels = TRUE, ylim = c(0, 60))
```


El gráfico de sedimentación (scree plot) muestra que los dos primeros componentes explican el 55.5% de la variabilidad total, mientras que los tres primeros explican el 78.3%, lo que indica que el PCA logra capturar de manera adecuada la estructura subyacente de los datos.


```{r}
fviz_pca_biplot(
  pca_res,
  repel = TRUE,
  col.var = "steelblue",
  col.ind = "gray20"
)

```

El biplot muestra la distribución de los países según sus características económicas y geoestratégicas proyectadas en las dos primeras dimensiones del PCA. Las flechas indican la dirección e intensidad con que cada variable contribuye a la estructura factorial: la IED china y el PBI se orientan en una misma dirección, reflejando su asociación positiva, mientras que el IDI y la ayuda estadounidense (USADF) se proyectan en sentidos opuestos, evidenciando patrones contrastantes entre desarrollo digital y apoyo estadounidense. La separación espacial de los países en el plano factorial permite identificar perfiles diferenciados según su tamaño económico, grado de digitalización y alineamientos geopolíticos.


### Análisis de Clúster:

### K-means

```{r}
#Preparación de los datos
cluster_data <- data %>%
  select(ied_china, pbi, usadf, idi_2024) %>%
  scale()
```

```{r}
library(factoextra)

#Determinar el número óptimo de clusters
fviz_nbclust(
  cluster_data, 
  kmeans, 
  method = "wss"
) +
  labs(title = "Método del Codo para determinar el número óptimo de clusters")
```

```{r}
set.seed(123)

# Calcular WSS para k = 1 a 10
wss <- sapply(1:10, function(k){
  kmeans(cluster_data, centers = k, nstart = 20)$tot.withinss
})

# Determinar el codo con el método Kneedle simplificado
k_vals <- 1:10
slope <- diff(wss)

# El codo es donde el cambio en WSS se vuelve más pequeño de forma abrupta
elbow_k <- which.min(diff(slope))
elbow_k

```
```{r}
#Método Silhouette
fviz_nbclust(
  cluster_data,
  kmeans,
  method = "silhouette"
) +
  labs(title = "Método Silhouette para determinar el número óptimo de clusters")

```

```{r}
#Ejecutar K-means
set.seed(123)
k5 <- kmeans(cluster_data, centers = 5, nstart = 25)

k5
```

```{r}
#Visualización de clusters
fviz_cluster(
  k5,
  data = cluster_data,
  geom = "point",
  ellipse.type = "norm",
  palette = "Dark2",
  ggtheme = theme_minimal()
)
```

Análisis de Clúster: K-means

Se aplicó un análisis de clúster mediante el método de K-means a las variables estandarizadas IED China, PBI, USADF e IDI 2024, con el objetivo de identificar grupos de países con patrones similares en términos de inversión china, tamaño económico, ayuda estadounidense y desarrollo digital.

Para determinar el número óptimo de clusters se utilizaron dos criterios: el método del codo (WSS) y el método Silhouette. El análisis indicó que entre 5 y 6 clusters es una opción adecuada; finalmente, se estimó un modelo con 5 clusters, considerando un balance entre la varianza explicada y la interpretabilidad de los grupos.

Los resultados muestran una distribución muy heterogénea entre los clusters, con tamaños que van desde un único país hasta 132 en el grupo más numeroso. Esto evidencia la existencia de un patrón dominante común entre la mayoría de países, acompañado de subgrupos pequeños con características económicas o geopolíticas muy particulares. En particular, algunos clusters concentran países con niveles extraordinariamente altos de IED china o de desarrollo digital, mientras que otros reflejan perfiles más moderados y equilibrados.

La proporción de varianza explicada entre grupos es elevada (83.3%), lo que indica que el modelo logra capturar diferencias sustantivas en la estructura multivariada de los datos. Además, la visualización mediante K-means muestra una separación clara entre los conglomerados, especialmente en los casos extremos, lo que refuerza la validez de la partición identificada. En conjunto, el análisis permite reconocer conjuntos de países con perfiles económicos y estratégicos similares, ofreciendo una base sólida para estudiar patrones internacionales de inversión china y orientar comparaciones o políticas de cooperación.


### Código PAM incluyendo categóricas 

```{r}
library(cluster)
library(dplyr)

# -----------------------------
# Preparación de datos
# -----------------------------
pam_data <- data %>% 
  select(country, ied_china, pbi, usadf, idi_2024, region, bri)

# Guardar nombres de país como fila
row.names(pam_data) <- pam_data$country

# Quitar columna país para distancia
pam_data_dist <- pam_data %>% select(-country)

# Calcular matriz de distancia Gower
gower_dist <- daisy(pam_data_dist, metric = "gower")

# -----------------------------
# Calcular siluetas para K = 2 a 10
# -----------------------------
sil_width <- numeric(9)  # índices 1:9 corresponden a K=2:10

for (k in 2:10) {
  pam_fit <- pam(gower_dist, diss = TRUE, k = k)
  sil_width[k-1] <- pam_fit$silinfo$avg.width
}

# Mostrar las siluetas
sil_width

# Detectar automáticamente el K con mayor silhouette promedio
k_optimo <- which.max(sil_width) + 1  # sumamos 1 porque el índice empieza en K=2
k_optimo

```

PASO 1 — Ejecutar PAM con K=10

```{r}
set.seed(123)

# Ejecutar PAM con K óptimo
pam_final <- pam(gower_dist, k = k_optimo, diss = TRUE)
```


PASO 2 — Agregar el cluster a la base

```{r}
# Agregar la columna de clusters al dataframe original
pam_data$pam_cluster <- pam_final$cluster

# Ver resumen de clusters
table(pam_data$pam_cluster)
```

PASO 3 — Ver siluetas del modelo 

```{r}
fviz_silhouette(pam_final)
```


El análisis de k-medoides (PAM), aplicado sobre una matriz de distancia Gower que incorpora variables numéricas y categóricas, mostró que el número óptimo de clusters es k = 10, de acuerdo con el mayor ancho promedio de silueta (0.723). Este valor es elevado, lo que indica una estructura de conglomerados bien definida y una separación clara entre los grupos. La distribución resultante (entre 6 y 39 países por cluster) evidencia heterogeneidad en los patrones económicos, digitales y geopolíticos que caracterizan a los países estudiados.


PASO 4 - Marcas los países mal clusterizados

```{r}
library(cluster)

# Calcular silhouette real
sil <- silhouette(pam_final$cluster, gower_dist)

# Crear data frame con nombres y silhouette
sil_df <- data.frame(
  country = rownames(pam_data),
  sil_width = sil[, "sil_width"]
)

# Extraer países mal clusterizados
poorPAM <- sil_df[sil_df$sil_width < 0, "country"] %>% sort()
poorPAM
```

PASO 5 — Agregar esta información al dataframe

```{r}
pam_data <- pam_data %>%
  mutate(pam_poor = country %in% poorPAM)

```


```{r}
data$pam_cluster <- pam_data$pam_cluster
data$pam_poor <- pam_data$pam_poor
```

### AGNES

```{r}
# Preparar datos
library(cluster)
library(dplyr)
library(factoextra)

# Seleccionar variables para AGNES
agnes_data <- data %>%
  select(country, ied_china, pbi, usadf, idi_2024, region, bri)

# Guardar nombres de fila
row.names(agnes_data) <- agnes_data$country

# Crear matriz de distancia Gower
agnes_dist <- daisy(agnes_data %>% select(-country), metric = "gower")

```

```{r}
set.seed(123)

res.agnes <- agnes(
  agnes_dist,
  diss = TRUE,
  method = "ward"
)
```

```{r}
# Determinar número óptimo de clusters
library(cluster)

sil_width_agnes <- c()
for (k in 2:10) {
  tmp_cluster <- cutree(as.hclust(res.agnes), k = k)
  sil <- silhouette(tmp_cluster, dist(agnes_dist))
  sil_width_agnes[k] <- mean(sil[, 3])
}

# Mostrar valores de silhouette promedio
sil_width_agnes

# Elegir K con mayor silhouette
k_optimo_agnes <- which.max(sil_width_agnes)
k_optimo_agnes
```
```{r}
agnes_clusters <- cutree(as.hclust(res.agnes), k = k_optimo_agnes)

# Agregar al dataframe original
agnes_data$agnes_cluster <- agnes_clusters

# Revisar primeros 15 países con clusters
head(agnes_data, 15)

```

```{r}
# Visualizar dendrograma y silhouettes

# Dendrograma
fviz_dend(res.agnes, cex = 0.7, horiz = TRUE, main = "")

# Silhouette
fviz_silhouette(silhouette(agnes_clusters, dist(agnes_dist)), print.summary = FALSE)

```

El agrupamiento jerárquico aglomerativo (AGNES), aplicado sobre una matriz de distancia Gower que combina variables económicas, digitales y categóricas, mostró que el número óptimo de clusters es k = 10, según el mayor ancho promedio de silueta (0.66). Este valor es relativamente alto para datos multivariados mixtos, lo que indica que los clusters formados presentan buena cohesión interna y separación entre grupos. El dendrograma evidencia divisiones bien definidas, especialmente entre países con altos niveles de desarrollo digital, aquellos con fuerte penetración de ayuda estadounidense y un pequeño subconjunto con niveles elevados de IED china.


```{r}

# Identificar países mal clusterizados
silAGNES <- data.frame(
  country = rownames(agnes_data),
  sil_width = silhouette(agnes_clusters, dist(agnes_dist))[, "sil_width"]
)

poorAGNES <- silAGNES %>% 
  filter(sil_width < 0) %>% 
  arrange(country)

poorAGNES$country

```
```{r}
#Revisar promedio de cada cluster
aggregate(. ~ agnes_cluster, data = agnes_data %>% select(-country), mean)

```

```{r}
#Agregar los clusters AGNES a tu dataset principal
data$agnes_cluster <- agnes_data$agnes_cluster
rm(agnes_data)
```

### DIANA

```{r}
# Preparar datos
library(cluster)
library(dplyr)
library(factoextra)

# Seleccionar variables para DIANA
diana_data <- data %>%
  select(country, ied_china, pbi, usadf, idi_2024, region, bri)

# Guardar nombres de fila
row.names(diana_data) <- diana_data$country

# Crear matriz de distancia Gower
diana_dist <- daisy(diana_data %>% select(-country), metric = "gower")

```

```{r}
set.seed(123)

res.diana <- diana(diana_dist)
```

```{r}
# Determinar número óptimo de clusters
sil_width_diana <- c()
for (k in 2:10) {
  tmp_cluster <- cutree(as.hclust(res.diana), k = k)
  sil <- silhouette(tmp_cluster, dist(diana_dist))
  sil_width_diana[k] <- mean(sil[, 3])
}

# Ver valores promedio de silhouette
sil_width_diana

# Elegir K óptimo
k_optimo_diana <- which.max(sil_width_diana)
k_optimo_diana

# Cortar dendrograma con K óptimo
diana_clusters <- cutree(as.hclust(res.diana), k = k_optimo_diana)
```
```{r}
# Agregar clusters al dataframe
diana_data$diana_cluster <- diana_clusters

# Revisar primeros 15 países
head(diana_data, 15)

```

```{r}
# Visualizar dendrograma y silhouettes

# Dendrograma
fviz_dend(res.diana, cex = 0.7, horiz = TRUE, main = "")

# Silhouette
fviz_silhouette(silhouette(diana_clusters, dist(diana_dist)), print.summary = FALSE)

```


El método divisivo DIANA identificó que el número óptimo de clusters es K = 2, de acuerdo con el máximo ancho de silueta promedio (0.55). Este valor indica una separación moderadamente clara entre dos grandes grupos de países. El primer cluster agrupa economías con valores relativamente bajos de IED china, PBI y digitalización, mientras que el segundo concentra países con niveles significativamente más altos en estas variables o con patrones geopolíticos distintivos. El dendrograma muestra una división inicial fuerte, característica del enfoque divisivo, lo que sugiere que la principal separación en los datos ocurre entre dos estructuras socioeconómicas amplias.


```{r}
#Identificar países mal clusterizados

silDIANA <- data.frame(
  country = rownames(diana_data),
  sil_width = silhouette(diana_clusters, dist(diana_dist))[, "sil_width"]
)

poorDIANA <- silDIANA %>%
  filter(sil_width < 0) %>%
  arrange(country)

poorDIANA$country

```
```{r}
#Revisar promedio de cada cluster
aggregate(. ~ diana_cluster, data = diana_data %>% select(-country), mean)
```

```{r}
# Agregar los clusters DIANA al dataset principal
data$diana_cluster <- diana_data$diana_cluster

# Marcar países mal clusterizados
data$diana_poor <- data$country %in% poorDIANA$country

# Eliminar la tabla auxiliar de DIANA
rm(diana_data)

```

### Visualización comparativa

```{r}
### Visualización comparativa

# Escalamiento Multidimensional (MDS)
proyeccion <- cmdscale(gower_dist, k = 2, add = TRUE)

# Agregar coordenadas al dataset principal
data$dim1 <- proyeccion$points[, 1]
data$dim2 <- proyeccion$points[, 2]

# Convertir clusters a factor (ya están en 'data')
data$pam_cluster <- as.factor(data$pam_cluster)
data$agnes_cluster <- as.factor(data$agnes_cluster)
data$diana_cluster <- as.factor(data$diana_cluster)

# Crear indicadores de países mal clusterizados
data$pamIDHpoor <- data$country %in% poorPAM
data$agnesIDHpoor <- data$country %in% poorAGNES$country
data$dianaIDHpoor <- data$country %in% poorDIANA$country
```

```{r}
# Base del gráfico
library(ggplot2)
library(ggrepel)

base <- ggplot(data, aes(x = dim1, y = dim2)) +
        theme_minimal() +
        labs(subtitle = "Se destacan los países mal clusterizados")
```


```{r}
# Gráfico PAM

PAMlabels <- ifelse(data$pamIDHpoor, data$country, '')

pamPlot <- base +
  geom_point(aes(color = pam_cluster), size = 3) +
  labs(title = "PAM") +
  geom_text_repel(aes(label = PAMlabels), 
                  size = 4, max.overlaps = 200,
                  min.segment.length = unit(0, 'lines'))
pamPlot
```


1. Interpretación del gráfico PAM

El gráfico PAM evidencia una estructura muy fragmentada, con 10 clusters dispersos y varios países ubicados cerca de fronteras entre grupos. Los puntos se encuentran relativamente mezclados y se observan múltiples casos mal asignados (silhouette < 0), lo que indica que el algoritmo no logra un particionado estable ni bien separado en el espacio MDS. La sobresegmentación produce clusters pequeños y poco consistentes, reduciendo la interpretabilidad del modelo.


```{r}
# Gráfico AGNES

AGNESlabels <- ifelse(data$agnesIDHpoor, data$country, '')

agnesPlot <- base +
  geom_point(aes(color = agnes_cluster), size = 3) +
  labs(title = "AGNES") +
  geom_text_repel(aes(label = AGNESlabels), 
                  size = 4, max.overlaps = 200,
                  min.segment.length = unit(0, 'lines'))

agnesPlot

```


2. Interpretación del gráfico AGNES

En el caso de AGNES, aunque también se genera una partición en 10 clusters, la separación entre grupos es algo más clara que en PAM. Sin embargo, aún persisten varios países mal clusterizados y solapamientos visibles entre regiones del espacio MDS. Esto sugiere que el método aglomerativo detecta ciertas estructuras, pero la elección de un número tan alto de grupos afecta su fortaleza clasificatoria y genera resultados menos estables.


```{r}
# Gráfico DIANA

DIANAlabels <- ifelse(data$dianaIDHpoor, data$country, '')

dianaPlot <- base +
  geom_point(aes(color = diana_cluster), size = 3) +
  labs(title = "DIANA") +
  geom_text_repel(aes(label = DIANAlabels), 
                  size = 4, max.overlaps = 50,
                  min.segment.length = unit(0, 'lines'))

dianaPlot

```
3. Interpretación del gráfico DIANA

El modelo DIANA muestra una separación nítida en solo dos clusters, con grupos bien definidos y sin solapamiento visible entre las clases. La distribución es limpia, los conglomerados están compactos y no se observan países mal asignados, lo que indica una coherencia alta entre la distancia Gower y la partición seleccionada. La estructura divisiva captura adecuadamente la principal ruptura entre países según las variables económicas y geopolíticas.

Comparando los tres métodos, DIANA es claramente el modelo superior.
Su partición presenta:

✔ Separación clara entre grupos
✔ Ningún país mal clusterizado
✔ Mayor consistencia interna (mayor silhouette promedio)
✔ Mejor interpretabilidad estructural

Tanto PAM como AGNES generan demasiados clusters y producen errores de asignación, mientras que DIANA ofrece una clasificación robusta, coherente y fácilmente interpretable para esta base de datos.

